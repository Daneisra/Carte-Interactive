<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Carte Interactive</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster/dist/MarkerCluster.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster/dist/MarkerCluster.Default.css" />
    <link rel="stylesheet" href="style.css">
    <link rel="stylesheet" href="editor.css">
    <link rel="icon" type="image/png" href="assets/icons/default.png">
</head>
<body>
    <div id="aria-status" class="sr-only" role="status" aria-live="polite" aria-atomic="true"></div>
    <div id="aria-alert" class="sr-only" role="alert" aria-live="assertive" aria-atomic="true"></div>
    <div id="user-admin-overlay" class="user-admin-overlay" hidden>
        <div class="user-admin-dialog" role="dialog" aria-modal="true" aria-labelledby="user-admin-title">
            <div id="user-admin-container" class="user-admin-container"></div>
        </div>
    </div>

    <!-- üß≠ Panneau Exploration -->
    <div id="sidebar">
        <h2>Exploration</h2>

        <!-- üåç Bouton pour masquer/afficher tous les continents -->
        <button id="toggle-all-continents" class="continent-toggle global-toggle" type="button">
            Tout masquer/afficher
        </button>
        
        <!-- üîç Barre de recherche avec bouton de r√©initialisation -->
        <div id="search-container">
            <input type="text" id="search-bar" placeholder="Rechercher un lieu..." />
            <button id="clear-search" aria-label="Effacer la recherche" type="button">‚úï</button>
            <span id="search-results-count" class="results-badge" data-state="all" aria-live="polite" aria-atomic="true">0 lieu</span>
        </div>

        <button id="add-location" class="primary-button" type="button">Ajouter un lieu</button>

        <div id="auth-panel" class="auth-panel" aria-live="polite">
            <p id="auth-status" class="auth-status">Connexion requise pour modifier les lieux.</p>
            <button id="login-button" class="secondary-button" type="button">Connexion Discord</button>
            <button id="logout-button" class="secondary-button" type="button" hidden>Se d√©connecter</button>
            <button id="user-admin-button" class="secondary-button" type="button" hidden>Gestion utilisateurs</button>
        </div>

        <div id="filters-container">
            <select id="type-filter" aria-label="Filtrer par type de lieu">
                <option value="all">Tous les types</option>
            </select>
            <button id="reset-filters" class="icon-button" aria-label="R√©initialiser les filtres" type="button">‚Ü∫</button>
            <button id="random-location" class="icon-button" type="button" aria-label="Choisir un lieu al√©atoire">üé≤</button>
        </div>
        <div id="clustering-container" class="toggle-row">
            <label for="clustering-toggle" class="toggle-label">
                <input type="checkbox" id="clustering-toggle" />
                <span>Regrouper les marqueurs</span>
            </label>
            <span id="clustering-metrics" class="toggle-hint" data-state="off" aria-live="polite" aria-atomic="true">üìç 0/0</span>
        </div>

        <div id="marker-scale-container" class="slider-row">
            <label for="marker-size" class="slider-label">Taille des marqueurs</label>
            <div class="slider-control">
                <input type="range" id="marker-size" min="70" max="130" step="5" value="100" aria-label="Ajuster la taille des marqueurs" />
                <span id="marker-size-value" class="slider-value" aria-live="polite" aria-atomic="true">100%</span>
            </div>
        </div>

        <div id="exploration-tabs" class="segmented-control" role="tablist">
            <button id="tab-all-locations" class="tab-button active" type="button" data-view="all" aria-pressed="true">Tous les lieux</button>
            <button id="tab-favorites" class="tab-button" type="button" data-view="favorites" aria-pressed="false">Favoris</button>
        </div>

        <div id="favorites-container" class="favorites-container" hidden aria-live="polite" aria-atomic="true"></div>
        <div id="continents-container"></div>
    </div>

    <!-- üè∞ Panneau d'information des lieux -->
    <div id="info-sidebar">
        <div id="info-header">
            <h3 id="info-title">Titre du lieu</h3>
            <div class="info-actions">
                <button id="edit-location" class="icon-button" type="button" aria-label="Modifier le lieu" disabled>‚úé</button>
                <button id="favorite-toggle" class="icon-button favorite-toggle" type="button" aria-label="Ajouter aux favoris" aria-pressed="false" disabled>‚òÜ</button>
                <button id="close-info-sidebar" class="close-btn" type="button" aria-label="Fermer le panneau">‚úñ</button>
            </div>
        </div>
    
        <!-- üìÇ Onglets de navigation -->
        <div id="info-tabs" role="tablist" aria-label="Sections d'information du lieu">
            <button id="info-tab-description" class="info-tab active" type="button" role="tab" data-tab="description" aria-controls="description-content" aria-selected="true" tabindex="0">Description</button>
            <button id="info-tab-image" class="info-tab" type="button" role="tab" data-tab="image" aria-controls="image-content" aria-selected="false" tabindex="-1">Image</button>
        </div>

        <!-- üéµ Lecteur audio compact -->
        <div id="audio-container">
            <p id="audio-title">üéß Ambiance sonore</p>
            <audio id="audio-player" controls>
                Votre navigateur ne supporte pas l'√©l√©ment audio.
            </audio>
            <button id="audio-fallback" class="audio-fallback" type="button" hidden>
                ‚ñ∂Ô∏è Lancer la lecture
            </button>
            <p id="audio-status" class="audio-status" role="status" aria-live="polite" hidden></p>
        </div>

        <!-- üìö Contenu des onglets -->
        <div id="info-content">
            <div id="description-content" class="info-content active" role="tabpanel" aria-labelledby="info-tab-description" tabindex="0">
                <p id="description-text">Description du lieu...</p>

                <!-- ‚ûï Sections d'informations suppl√©mentaires -->
                <div id="history-section" class="extra-section" data-section="history"></div>
                <div id="quests-section" class="extra-section" data-section="quests"></div>
                <div id="pnjs-section" class="extra-section" data-section="pnj"></div>
                <div id="lore-section" class="extra-section" data-section="lore"></div>

            </div>

            <div id="image-content" class="info-content" role="tabpanel" aria-labelledby="info-tab-image" aria-hidden="true" tabindex="-1">
                <div id="image-gallery"></div>
            </div>
        </div>

    </div>

    <!-- üìú Historique modernis√© en bas √† gauche -->
        <div id="history-container">
            <p id="history-title">Historique</p>
            <div id="history-list"></div> <!-- Les √©l√©ments de l'historique seront ins√©r√©s ici -->
            <button id="history-back" type="button">Retour</button> <!-- Bouton Retour plac√© sous l'historique -->
        </div>

        <div id="events-feed" aria-live="polite" aria-atomic="false">
            <div class="feed-header">
                <h4 id="events-feed-title">Flux temps r√©el</h4>
                <label for="events-filter" class="sr-only">Filtrer les √©v√©nements</label>
                <select id="events-filter">
                    <option value="all">Tous</option>
                    <option value="annotations">Annotations</option>
                    <option value="quests">Qu√™tes</option>
                    <option value="sync">Synchronisations</option>
                </select>
            </div>
            <div id="events-feed-empty">Aucun √©v√©nement pour le moment.</div>
            <ul id="events-feed-list"></ul>
        </div>

        <!-- üó∫Ô∏è Conteneur de la carte -->
        <div class="map-wrapper">
            <div id="map"></div>
        </div>

    <!-- üéõÔ∏è Barre de contr√¥le en bas √† droite -->
    <div id="map-controls">
        <button id="zoom-in" aria-label="Zoom avant" type="button"><span aria-hidden="true">&#x2795;</span></button>
        <button id="zoom-out" aria-label="Zoom arri√®re" type="button"><span aria-hidden="true">&#x2796;</span></button>
        <button id="reset-map" aria-label="Recentrer la carte" type="button" title="Recentrer"><span aria-hidden="true">&#x21BA;</span></button>
        <button id="fullscreen-map" aria-label="Plein √©cran" type="button" title="Plein √©cran"><span aria-hidden="true">&#x2922;</span></button>
        <button id="measure-distance" class="map-control-button" type="button" aria-label="Mesurer une distance" aria-pressed="false" title="Mesurer une distance"><span aria-hidden="true">&#x1F4CF;</span></button>
        <button id="capture-coordinates" class="map-control-button" type="button" aria-label="Obtenir les coordonn√©es" aria-pressed="false" title="Obtenir les coordonn√©es"><span aria-hidden="true">&#x1F4CD;</span></button>
        <button id="annotation-mode" class="map-control-button" type="button" aria-label="Ajouter une annotation" aria-pressed="false" title="Ajouter une annotation"><span aria-hidden="true">&#x1F58C;</span></button>
        <div id="theme-toggle" class="theme-toggle" role="group" aria-label="Mode d'affichage">
            <button type="button" class="theme-toggle-option active" data-theme="dark" aria-pressed="true" title="Mode sombre">
                <span aria-hidden="true">&#x1F319;</span>
            </button>
            <button type="button" class="theme-toggle-option" data-theme="light" aria-pressed="false" title="Mode clair">
                <span aria-hidden="true">&#x2600;</span>
            </button>
        </div>
        <span id="zoom-level">100%</span>
    </div>

    <!-- üñºÔ∏è Lightbox pour les m√©dias -->
    <div id="media-lightbox" class="media-lightbox" role="dialog" aria-modal="true" hidden>
        <button id="media-lightbox-close" class="media-lightbox-close" type="button" aria-label="Fermer l'aper√ßu">√ó</button>
        <img id="media-lightbox-image" class="media-lightbox-image" alt="">
        <p id="media-lightbox-caption" class="media-lightbox-caption"></p>
    </div>
    <div id="location-editor" class="editor-overlay" role="presentation" hidden>
        <div class="editor-dialog" role="dialog" aria-modal="true" aria-labelledby="location-editor-title">
            <header class="editor-header">
                <h2 id="location-editor-title">√âditer un lieu</h2>
                <button id="location-editor-close" class="editor-close" type="button" aria-label="Fermer">√ó</button>
            </header>
            <form id="location-editor-form" novalidate>
                <div class="editor-content">
                    <fieldset class="editor-section" data-drop-zone="audio">
                        <legend>Informations g√©n√©rales</legend>
                        <div class="form-row">
                            <label for="editor-name">Nom</label>
                            <input id="editor-name" name="name" type="text" required />
                            <p class="form-error" data-error-for="name"></p>
                        </div>
                        <div class="form-row">
                            <label for="editor-continent">Continent</label>
                            <input id="editor-continent" name="continent" type="text" required />
                            <p class="form-error" data-error-for="continent"></p>
                        </div>
                        <div class="form-row">
                            <label for="editor-type">Type</label>
                            <select id="editor-type" name="type" required></select>
                            <p class="form-error" data-error-for="type"></p>
                        </div>
                        <div class="form-grid">
                            <div class="form-row">
                                <label for="editor-x">Coordonn√©e X</label>
                                <input id="editor-x" name="x" type="number" step="1" required />
                                <p class="form-error" data-error-for="x"></p>
                            </div>
                            <div class="form-row">
                                <label for="editor-y">Coordonn√©e Y</label>
                                <input id="editor-y" name="y" type="number" step="1" required />
                                <p class="form-error" data-error-for="y"></p>
                            </div>
                        </div>
                        <div class="form-row">
                            <label for="editor-description">Description</label>
                            <div class="markdown-toolbar" data-role="description-toolbar">
                                <button type="button" class="toolbar-button" data-md="**|**" aria-label="Texte gras"><span>G</span></button>
                                <button type="button" class="toolbar-button" data-md="*|*" aria-label="Texte italique"><span>I</span></button>
                                <button type="button" class="toolbar-button" data-md="### |" aria-label="Titre niveau 3"><span>H3</span></button>
                                <button type="button" class="toolbar-button" data-md="- |" aria-label="Liste"><span>‚Ä¢</span></button>
                                <button type="button" class="toolbar-button" data-md="> |" aria-label="Citation"><span>&gt;</span></button>
                                <button type="button" class="toolbar-button" data-md="[texte](url)" aria-label="Lien">üîó</button>
                                <span class="toolbar-hint">Markdown</span>
                            </div>
                            <textarea id="editor-description" name="description" rows="6"></textarea>
                            <div class="markdown-preview" data-preview="description-markdown">
                                <p class="markdown-preview-empty">Previsualisation en direct du rendu Markdown.</p>
                                <div class="markdown-preview-body markdown-content" data-role="description-preview-body" hidden></div>
                            </div>
                            <p class="form-error" data-error-for="description"></p>
                        </div>
                        <div class="form-row">
                            <label for="editor-audio">Audio (optionnel)</label>
                            <div class="input-with-button">
                                <input id="editor-audio" name="audio" type="url" placeholder="assets/audio/example.mp3" />
                                <button type="button" class="secondary-button" data-action="upload-audio">Importer un audio</button>
                            </div>
                            <p class="form-error" data-error-for="audio"></p>
                        </div>
                    </fieldset>

                    <fieldset class="editor-section" data-drop-zone="image">
                        <legend>Images</legend>
                        <div class="editor-list" data-role="image-list"></div>
                        <div class="editor-actions-row">
                            <button type="button" class="secondary-button" data-action="add-image">Ajouter une image</button>
                            <button type="button" class="secondary-button" data-action="upload-image">Importer une image</button>
                        </div>
                        <p class="form-error" data-error-for="images"></p>
                        <div class="media-preview" data-preview="images"></div>
                    </fieldset>

                    <fieldset class="editor-section" data-drop-zone="video">
                        <legend>Vid√©os</legend>
                        <div class="editor-list" data-role="video-list"></div>
                        <button type="button" class="secondary-button" data-action="add-video">Ajouter une vid√©o</button>
                        <p class="form-error" data-error-for="videos"></p>
                        <div class="media-preview" data-preview="videos"></div>
                    </fieldset>

                    <fieldset class="editor-section" data-drop-zone="pnj">
                        <legend>Personnages (PNJ)</legend>
                        <div class="editor-list" data-role="pnj-list"></div>
                        <button type="button" class="secondary-button" data-action="add-pnj">Ajouter un PNJ</button>
                        <p class="form-error" data-error-for="pnjs"></p>
                        <div class="media-preview" data-preview="pnjs"></div>
                    </fieldset>

                    <fieldset class="editor-section">
                        <legend>D√©tails suppl√©mentaires</legend>
                        <div class="form-row">
                            <label for="editor-history">Historique<br><span class="hint">(une entr√©e par ligne)</span></label>
                            <textarea id="editor-history" name="history" rows="3"></textarea>
                        </div>
                        <div class="form-row">
                            <label for="editor-quests">Qu√™tes<br><span class="hint">(une entr√©e par ligne)</span></label>
                            <textarea id="editor-quests" name="quests" rows="3"></textarea>
                        </div>
                        <div class="form-row">
                            <label for="editor-lore">Lore<br><span class="hint">(une entr√©e par ligne)</span></label>
                            <textarea id="editor-lore" name="lore" rows="3"></textarea>
                        </div>
                    </fieldset>

                    <fieldset class="editor-section" id="quest-events-section">
                        <legend>√âv√©nements de qu√™te</legend>
                        <div class="quest-events-disabled" data-role="quest-events-disabled" hidden>
                            Enregistrez le lieu pour g√©rer les √©v√©nements de qu√™te.
                        </div>
                        <div class="quest-events-list-wrapper" data-role="quest-events" hidden>
                            <p class="quest-events-empty" data-role="quest-events-empty">Aucun √©v√©nement enregistr√© pour ce lieu.</p>
                            <ul class="quest-events-list" data-role="quest-events-list"></ul>
                        </div>
                        <div class="quest-event-form" data-role="quest-event-form">
                            <div class="form-grid">
                                <div class="form-row">
                                    <label for="quest-event-id">Identifiant de qu√™te</label>
                                    <input id="quest-event-id" name="quest-event-id" type="text" data-role="quest-event-quest-id" placeholder="ex: QST-012" />
                                </div>
                                <div class="form-row">
                                    <label for="quest-event-status">Statut</label>
                                    <select id="quest-event-status" name="quest-event-status" data-role="quest-event-status">
                                        <option value="planifie">Planifi√©e</option>
                                        <option value="en cours" selected>En cours</option>
                                        <option value="termine">Termin√©e</option>
                                        <option value="bloque">Bloqu√©e</option>
                                    </select>
                                </div>
                                <div class="form-row">
                                    <label for="quest-event-milestone">Jalon</label>
                                    <input id="quest-event-milestone" name="quest-event-milestone" type="text" data-role="quest-event-milestone" placeholder="√âtape ou objectif" />
                                </div>
                                <div class="form-row">
                                    <label for="quest-event-progress-current">Progression</label>
                                    <div class="input-inline">
                                        <input id="quest-event-progress-current" name="quest-event-progress-current" type="number" min="0" data-role="quest-event-progress-current" placeholder="Actuel" />
                                        <span class="input-separator">/</span>
                                        <input id="quest-event-progress-max" name="quest-event-progress-max" type="number" min="0" data-role="quest-event-progress-max" placeholder="Total" />
                                    </div>
                                </div>
                                <div class="form-row form-row-wide">
                                    <label for="quest-event-note">Notes compl√©mentaires</label>
                                    <textarea id="quest-event-note" name="quest-event-note" rows="2" data-role="quest-event-note" placeholder="Informations additionnelles (optionnel)"></textarea>
                                </div>
                            </div>
                            <div class="editor-actions-row quest-event-actions">
                                <button type="button" class="secondary-button" data-action="quest-event-cancel" hidden>Annuler la modification</button>
                                <button type="button" class="secondary-button" data-action="quest-event-submit">Enregistrer un √©v√©nement</button>
                            </div>
                            <p class="form-error" data-error-for="quest-events"></p>
                        </div>
                    </fieldset>
                </div>
                <input type="file" id="editor-image-upload" accept="image/*" hidden />
                <input type="file" id="editor-audio-upload" accept="audio/*" hidden />

                <footer class="editor-actions">
                    <p class="form-error" data-error-for="form"></p>
                    <button type="button" class="danger-button" data-action="delete">Supprimer</button>
                    <button type="button" class="secondary-button" data-action="cancel">Annuler</button>
                    <button type="submit" class="primary-button" data-action="submit">Enregistrer</button>
                </footer>
            </form>
        </div>
    </div>

    <!-- ‚öôÔ∏è Scripts -->
    <script src="https://cdn.jsdelivr.net/npm/marked@12.0.2/marked.min.js" defer></script>
    <script src="https://cdn.jsdelivr.net/npm/dompurify@3.0.3/dist/purify.min.js" defer></script>
    <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
    <script src="https://unpkg.com/leaflet.markercluster/dist/leaflet.markercluster.js"></script>
    <script type="module" src="js/main.js"></script>

</body>
</html>









